# ⛳ Linux의 평균 부하(Load Average)에 대해 이해하기

시스템이 느릴 때, `top`이나 `uptime` 명령어로 시스템의 부하를 확인할 수 있다.

```bash
$ uptime
02:34:03 up 2 days, 20:14,  1 user,  load average: 0.63, 0.83, 0.88
# 현재 시각, 시스템의 가동 시간, 로그인한 사용자 수, 지난 1분/5분/15분 동안의 평균 부하
```

여기서 🚨 **평균 부하** 🚨란?

- **특정 시간 동안 실행 가능한 상태(Runnable)나 중단 불가능한(Uninterruptible) 상태에 있는 프로세스의 평균 수**
- **활성 프로세스의 평균 수**라고도 하며, CPU 사용률과는 직접적으로 관련이 없다.

<br>

### ⛽ **Runnable(실행 가능한)과 Uninterruptible(중단 불가능한) 상태**

- **실행 가능한 프로세스**
    - **CPU를 사용**하고 있거나 **CPU 사용을 기다리고 있는** 프로세스를 의미
    - `ps` 명령어에서 **`R`** 상태로 표시된다.
- **중단 불가 상태의 프로세스**
    - 주로 **I/O 작업을 기다리는** 프로세스로, 이 상태에서는 프로세스가 중단될 수 없다.
    - `ps` 명령어에서 **`D`** 상태로 표시된다.

즉, 평균 부하는 **실행 중이거나 CPU 또는 I/O를 대기 중인 활성 프로세스의 수**를 나타낸다.

<br>

### ⚓ 평균 부하와 CPU 사용률의 차이

**Case 1.** **CPU 집약적 작업**이 많을 경우

- CPU 사용률과 평균 부하가 **모두 높음**

**Case 2.** **I/O 작업 대기 중**인 프로세스가 많을 경우

- **CPU 사용률은 낮지만** **평균 부하는 높을 수 있음**
- 많은 프로세스가 CPU 대신 I/O 작업을 기다리고 있기 때문

<br>

### 📃  시스템의 평균 부하를 평가하는 방법

**`uptime`** 명령어를 통해 나타나는 평균 부하 값을 어떻게 해석해야 할까?

**평균 부하의 이상적인 상황은 CPU 수와 같을 때**이다. 즉, 각 CPU가 완전히 사용되고 있지만, 과부하 없이 적절히 일해야 한다는 뜻이다.

따라서 평균 부하를 평가할 때 가장 먼저 알아야 할 것은 시스템에 **몇 개의 CPU가 있는지**이다. 이는 **`top`** 명령어로 확인할 수 있으며, **`/proc/cpuinfo`** 파일을 읽어서도 알 수 있다.

```bash
 $ grep 'model name' /proc/cpuinfo | wc -l
 2  # CPU 개수
```

<br>

이때, **평균 부하가 CPU 수를 초과할 때 시스템이 과부하 상태**에 있다고 판단할 수 있다. 그렇다면 **세 가지 평균 부하 값 중에서 어떤 것을 참고해야 할까?**

사실, 세 가지 값을 **모두 고려해** 시스템 부하의 **추세를 분석**해야 한다. 

**Case 1.** 1분, 5분, 15분 값이 **비슷하거나 크게 차이가 나지 않는 경우**

- 시스템 부하가 **안정적**이라는 것을 의미

**Case 2.** 각 **간격 간 차이가 심한 경우**

- 1분 값이 15분 값보다 훨씬 낮다면, 최근 1분 동안 부하가 감소했으며, 지난 15분 동안은 상당한 부하가 있었음을 나타냄
- 반대로 1분 값이 15분 값보다 훨씬 높다면, 최근 1분 동안 부하가 증가했음을 의미
- **1분 평균 부하**가 CPU 수에 근접하거나 이를 초과할 때, 시스템이 과부하 상태에 있음을 의미하며, **이 시점에서 문제의 원인을 분석하고 최적화할 필요**가 있음

만약 1.73, 0.60, 7.98이라는 평균 부하를 가진 단일 CPU 시스템을 본다면, 이는 지난 1분 동안 시스템이 73% 과부하 상태에 있었고, 지난 15분 동안에는 698% 과부하 상태에 있었다는 것을 나타낸다. 하지만 전체적인 추세는 시스템 부하가 감소하고 있음을 보여준다.

<br>

### 🖥️ 어느 정도의 평균 부하부터 주의해야 할까?

**평균 부하가 CPU 수의 70%를 초과할 때** 높은 부하 문제를 분석하고 조사해야 한다.

하지만 이는 절대적인 기준 값은 아니며, **더 많은 과거 데이터를 기반으로 부하의 추세를 판단하는 것**이 좋다.

<br>

### 🎥 부하 원인 분석 도구

- **mpstat**: CPU의 실시간 사용량을 분석하는 도구로, CPU가 얼마나 바쁜지 확인할 수 있다.
- **pidstat**: 특정 프로세스의 CPU, 메모리, I/O 사용량을 확인할 수 있다.
- **stress**: CPU 또는 I/O에 부하를 걸어 시스템을 테스트할 수 있다.

<br>

### 📌 결론

평균 부하는 시스템 성능을 빠르게 파악할 수 있는 유용한 지표이다. 하지만, 평균 부하만으로는 시스템의 병목 지점이나 문제 원인을 알 수 없으므로 추가적인 도구(mpstat, pidstat 등)를 사용해 부하 원인을 분석하는 것이 중요하다. CPU 사용률이 높지 않더라도 I/O 또는 프로세스 대기 상황에서 평균 부하가 높을 수 있다는 점을 유의해야 한다.

<br>

### 📎 참고 문헌
[Deep Understanding of Average Load in Linux](https://blog.devgenius.io/deep-understanding-of-average-load-in-linux-74822e1dbcb1)
